---
- name: Install and configure Microshift
  hosts: microshift
  gather_facts: false
  become: true
  user: arthur
  tasks:
    - name: CGroupsV2
      ansible.builtin.copy:
        src: "../../../../machineConfigs/servers/microshift/boot/cmdline.txt"
        dest: "/boot/cmdline.txt"
        mode: "0644"

    - name: Install CentOS && OKD packages
      ansible.builtin.dnf:
        state: present
        name:
          # renovate: datasource=repology depName=centos_stream_10/centos-release-openstack-zed
          - centos-release-openstack-zed-1-1.el10
          # renovate: datasource=repology depName=centos_stream_10/centos-release-okd-4.16
          - centos-release-okd-4.16-1-1.el10

    - name: Remove CentOS-OpenStack-zed.repo
      ansible.builtin.file:
        path: /etc/yum.repos.d/CentOS-OpenStack-zed.repo
        state: absent

    - name: Install CRI-O packages
      ansible.builtin.dnf:
        state: present
        name:
          # renovate: datasource=repology depName=centos_stream_10/cri-o
          - cri-o-1.28.0
          # renovate: datasource=repology depName=centos_stream_10/cri-tools
          - cri-tools-1.28.0
          # renovate: datasource=repology depName=centos_stream_10/containernetworking-plugins
          - containernetworking-plugins-1.3.0

    - name: Copy Pull Secret
      ansible.builtin.copy:
        src: "/tmp/pull_secret.json"
        dest: "/etc/crio/openshift-pull-secret"
        mode: "0600"
        owner: root
        group: root

    - name: Make sure cri-o service unit is running
      ansible.builtin.systemd:
        state: started
        enabled: true
        name: crio

    - name: MicroShift Dir
      ansible.builtin.file:
        path: "/etc/microshift"
        state: directory
        mode: "0755"

    - name: MicroShift Config Dir
      ansible.builtin.file:
        path: "/etc/microshift/config.d/"
        state: directory
        mode: "0755"

    - name: MicroShift HostName
      ansible.builtin.copy:
        src: "../../../../machineConfigs/servers/microshift/etc/microshift/config.d/10-subjectAltNames.yaml"
        dest: "/etc/microshift/config.d/10-subjectAltNames.yaml"
        mode: "0644"

    - name: MicroShift Gateway
      ansible.builtin.copy:
        src: "../../../../machineConfigs/servers/microshift/etc/microshift/ovn.yaml"
        dest: "/etc/microshift/ovn.yaml"
        mode: "0644"

    - name: Enable project redhat-et/microshift-testing
      ansible.builtin.yum_repository:
        name: redhat-et
        description: redhat-et/microshift-testing
        baseurl: https://download.copr.fedorainfracloud.org/results/@redhat-et/microshift-testing/centos-stream-10-aarch64
        gpgkey: https://download.copr.fedorainfracloud.org/results/@redhat-et/microshift-testing/pubkey.gpg
        mode: "0644"

    - name: Install Microshift packages
      ansible.builtin.dnf:
        state: present
        name:
          # renovate: datasource=repology depName=centos_stream_10/microshift
          - microshift-4.16.0-202406111433.p0.g8966666.assembly.4.16.0.el10
          # renovate: datasource=repology depName=centos_stream_10/microshift-networking
          - microshift-networking-4.16.0-202406111433.p0.g8966666.assembly.4.16.0.el10
          # renovate: datasource=repology depName=centos_stream_10/microshift-greenboot
          - microshift-greenboot-4.16.0-202406111433.p0.g8966666.assembly.4.16.0.el10
          # renovate: datasource=repology depName=centos_stream_10/microshift-selinux
          - microshift-selinux-4.16.0-202406111433.p0.g8966666.assembly.4.16.0.el10

    - name: Firewalld pod network
      ansible.posix.firewalld:
        zone: trusted
        source: 10.42.0.0/16
        permanent: true
        state: enabled

    - name: Firewalld port 80
      ansible.posix.firewalld:
        zone: public
        port: 80/tcp
        permanent: true
        state: enabled

    - name: Firewalld port 443
      ansible.posix.firewalld:
        zone: public
        port: 443/tcp
        permanent: true
        state: enabled

    - name: Firewalld port 5353
      ansible.posix.firewalld:
        zone: public
        port: 5353/udp
        permanent: true
        state: enabled

    - name: Firewalld port 6443
      ansible.posix.firewalld:
        zone: public
        port: 6443/tcp
        permanent: true
        state: enabled

    - name: Firewalld nodeports
      ansible.posix.firewalld:
        zone: public
        port: 30000-32767/tcp
        permanent: true
        state: enabled

    - name: Make sure microshift service unit is running
      ansible.builtin.systemd:
        state: started
        enabled: true
        name: microshift

    - name: Create a directory /.kube if it does not exist
      ansible.builtin.file:
        path: /home/arthur/.kube/
        state: directory
        mode: "0755"
        owner: arthur
        group: arthur

    - name: Kubeconfig
      ansible.builtin.copy:
        src: "/var/lib/microshift/resources/kubeadmin/kubeconfig"
        dest: "/home/arthur/.kube/config"
        mode: "0600"
        remote_src: true
        owner: arthur
        group: arthur
      retries: 3
      delay: 3
