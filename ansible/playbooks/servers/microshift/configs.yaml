---
- name: Configure Microshift nodes
  hosts: microshift
  gather_facts: false
  become: true
  user: arthur
  tasks:
    - name: Set a hostname
      ansible.builtin.hostname:
        name: microshift.arthurvardevanyan.com

    - name: Add Local DNS for MicroShift
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: 10.101.1.7 microshift microshift.arthurvardevanyan.com
        create: true
        mode: "0644"

    - name: CGroupsV2
      ansible.builtin.copy:
        src: "../../../../machineConfigs/servers/microshift/boot/cmdline.txt"
        dest: "/boot/cmdline.txt"
        mode: "0644"

    - name: Load iptables modules
      community.general.modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - iptable_filter
        - iptable_nat
        - iptable_mangle
      failed_when: false

    - name: Persist iptables modules
      ansible.builtin.copy:
        dest: /etc/modules-load.d/kube-vip.conf
        content: |
          iptable_filter
          iptable_nat
          iptable_mangle
        mode: "0644"

    - name: Create partition
      community.general.parted:
        device: /dev/nvme0n1
        number: 3
        flags: [lvm]
        state: present

    - name: RHEL volumegroup
      community.general.lvg:
        vg: rhel
        pvs: /dev/nvme0n1p3

    - name: Logical volume test
      community.general.lvol:
        vg: rhel
        lv: rhel
        size: 1g
        force: true
