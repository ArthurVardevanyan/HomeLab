---
- name: Install and configure Promtail
  hosts: servers-x86
  gather_facts: false
  become: true
  user: arthur
  tasks:
    # https://www.ozonejunkie.com/posts/loki-rhel/
    - name: Download PromTail
      ansible.builtin.get_url:
        # renovate: datasource=github-releases depName=grafana/loki
        url: https:v3.6.3
        dest: /tmp/promtail-linux-amd64.zip
        mode: "0644"
      check_mode: false

    - name: PromTail
      ansible.builtin.file:
        path: /tmp/promtail-linux-amd64
        state: directory
        mode: "0755"
      check_mode: false

    - name: Extract PromTail
      ansible.builtin.unarchive:
        src: /tmp/promtail-linux-amd64.zip
        dest: /tmp/promtail-linux-amd64
        remote_src: true
      check_mode: false

    - name: Copy PromTail Binary To Bin
      ansible.builtin.copy:
        src: /tmp/promtail-linux-amd64/promtail-linux-amd64
        dest: /usr/local/bin/promtail-linux-amd64
        mode: "0755"
        remote_src: true

    - name: Promtail Systemd File
      ansible.builtin.copy:
        src: "../../../../../machineConfigs/servers/server/etc/systemd/system/promtail.service"
        dest: "/etc/systemd/system/promtail.service"
        mode: "0644"
      notify: Restart PromTail SystemD

    - name: Enable PromTail SystemD
      ansible.builtin.systemd_service:
        enabled: true
        name: promtail
        state: started
        daemon_reload: true

    - name: SeLinux File
      ansible.builtin.copy:
        src: "../../../../../machineConfigs/servers/server/home/arthur/promtail.te"
        dest: "/home/arthur/promtail.te"
        mode: "0644"
      notify: Install SeLinux Policy

  handlers:
    - name: Restart PromTail SystemD
      ansible.builtin.systemd_service:
        enabled: true
        name: promtail
        state: restarted
        daemon_reload: true

    - name: Install SeLinux Policy
      ansible.builtin.shell: |
        checkmodule -M -m -o promtail.mod promtail.te
        semodule_package -o promtail.pp -m promtail.mod
        semodule -i promtail.pp
      args:
        chdir: /home/arthur
      changed_when: true
