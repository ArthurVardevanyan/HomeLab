apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: terraform
spec:
  params:
    - name: terraform_action
      type: string
      default: "plan"
    - name: terraform_path
      type: string
      default: "terraform/homelab"
    - name: terraform_bucket
      type: string
      default: "tf-state-homelab"
    - name: terraform_secret
      type: string
      default: "secret/gcp/org/av/projects"
    - name: terraform_simple_bucket
      type: string
      default: "false"
    - name: vault_auth_path
      type: string
      default: "auth/homelab/login"
    - name: vault_role
      type: string
      default: "homelab"
    - name: vault_addr
      type: string
      default: "https://vault.arthurvardevanyan.com"
    - name: zitadel_secret_name
      type: string
      default: "zitadel_pipeline"
    - name: gcp_project_prefix
      type: string
      default: "homelab-"
    - name: terraform_state_prefix
      type: string
      default: "terraform/state"
    - name: terraform_vars
      type: string
      default: ""
    - name: terraform_output_json
      type: string
      default: "false"
    - name: zitadel
      type: string
      default: "false"
    - name: image
      type: string
      default: "registry.arthurvardevanyan.com/homelab/toolbox:not_latest"

  workspaces:
    - name: data

  results:
    - name: terraform_json
      description: The JSON output of the terraform command

  steps:
    - name: terraform
      image: "$(params.image)"
      computeResources:
        limits:
          cpu: 750m
          memory: 1Gi
        requests:
          cpu: 250m
          memory: 512Mi
      securityContext:
        runAsNonRoot: true
        #runAsUser: 65532
        privileged: false
        readOnlyRootFilesystem: true
        allowPrivilegeEscalation: false
        seccompProfile:
          type: RuntimeDefault
        capabilities:
          drop:
            - ALL
            - MKNOD
      env:
        - name: WORKSPACE_DATA_PATH
          value: $(workspaces.data.path)
        - name: TERRAFORM_PATH
          value: $(params.terraform_path)
        - name: TERRAFORM_ACTION
          value: $(params.terraform_action)
        - name: TERRAFORM_BUCKET
          value: $(params.terraform_bucket)
        - name: TERRAFORM_SECRET
          value: $(params.terraform_secret)
        - name: TERRAFORM_SIMPLE_BUCKET
          value: $(params.terraform_simple_bucket)
        - name: VAULT_AUTH_PATH
          value: $(params.vault_auth_path)
        - name: VAULT_ROLE
          value: $(params.vault_role)
        - name: VAULT_ADDR
          value: $(params.vault_addr)
        - name: ZITADEL_SECRET_NAME
          value: $(params.zitadel_secret_name)
        - name: GCP_PROJECT_PREFIX
          value: $(params.gcp_project_prefix)
        - name: TERRAFORM_STATE_PREFIX
          value: $(params.terraform_state_prefix)
        - name: TERRAFORM_VARS
          value: $(params.terraform_vars)
        - name: TERRAFORM_OUTPUT_JSON
          value: $(params.terraform_output_json)
        - name: ZITADEL
          value: $(params.zitadel)
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /var/run/secrets/google/credentials_config.json
        - name: CLOUDSDK_AUTH_CREDENTIAL_FILE_OVERRIDE
          value: /var/run/secrets/google/credentials_config.json

      volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: gcp-credentials-request
          readOnly: true
          mountPath: /var/run/secrets/google
        - name: serviceaccount-token
          readOnly: true
          mountPath: /var/run/secrets/openshift/serviceaccount
      script: |
        #!/bin/bash

        set -o errexit
        set -o nounset
        set -o pipefail

        export CI_JOB_JWT="$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)"
        export VAULT_TOKEN="$(vault write -field=token ${VAULT_AUTH_PATH} role=${VAULT_ROLE} jwt=${CI_JOB_JWT})"

        export PROJECT_ID="$(vault kv get -field=project_id ${TERRAFORM_SECRET})"
        export BUCKET_ID="$(vault kv get -field=bucket_id ${TERRAFORM_SECRET})"

        if [[ "${ZITADEL}" == "true" ]]; then
          gcloud auth login --cred-file=${GOOGLE_APPLICATION_CREDENTIALS}
          gcloud secrets versions access latest --project="${GCP_PROJECT_PREFIX}${PROJECT_ID}" --out-file="/tmp/zitadel.json" --secret ${ZITADEL_SECRET_NAME}
        fi

        cd ${WORKSPACE_DATA_PATH}/${TERRAFORM_PATH}

        if [[ "${TERRAFORM_SIMPLE_BUCKET}" == "true" ]]; then
          FINAL_BUCKET="tf-state-${PROJECT_ID}"
        else
          FINAL_BUCKET="${TERRAFORM_BUCKET}-${BUCKET_ID}"
        fi

        cat << EOF > backend.conf
        bucket = "${FINAL_BUCKET}"
        prefix = "${TERRAFORM_STATE_PREFIX}"
        EOF

        echo "Running Tofu Init"
        tofu init -no-color -backend-config=backend.conf
        if [[ "${TERRAFORM_ACTION}" = "plan" ]]; then
          echo "Running Tofu Plan"
          if [[ "${TERRAFORM_OUTPUT_JSON}" == "true" ]]; then
             tofu plan -no-color -out=tfplan ${TERRAFORM_VARS}
             tofu show -json tfplan > $(results.terraform_json.path)
          else
             tofu plan -no-color ${TERRAFORM_VARS}
          fi
        elif [[ "${TERRAFORM_ACTION}" = "apply" ]]; then
          echo "Running Tofu Apply"
          if [[ "${TERRAFORM_OUTPUT_JSON}" == "true" ]]; then
             tofu apply -no-color -auto-approve -json ${TERRAFORM_VARS} > $(results.terraform_json.path)
          else
             tofu apply -no-color -auto-approve ${TERRAFORM_VARS}
          fi
        fi

  volumes:
    - name: tmp
      emptyDir:
        sizeLimit: 100Mi
    - name: gcp-credentials-request
      configMap:
        name: gcp-credentials-request
        defaultMode: 420
    - name: serviceaccount-token
      projected:
        sources:
          - serviceAccountToken:
              audience: openshift
              expirationSeconds: 3600
              path: token
        defaultMode: 420
