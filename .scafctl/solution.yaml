apiVersion: scafctl.io/v1
kind: Solution

metadata:
  name: generate-argocd-apps
  version: 1.0.0
  description: Generate ArgoCD Application manifests for kubernetes folders

spec:
  resolvers:
    repoURL:
      description: Git repository URL
      type: string
      resolve:
        with:
          - provider: parameter
            inputs:
              key: repo
          - provider: static
            inputs:
              value: "https://git.arthurvardevanyan.com/ArthurVardevanyan/HomeLab"

    kubernetesDir:
      description: Path to kubernetes directory
      type: string
      resolve:
        with:
          - provider: parameter
            inputs:
              key: kubeDir
          - provider: static
            inputs:
              value: "./kubernetes"

    outputDir:
      description: Output directory for ArgoCD applications
      type: string
      resolve:
        with:
          - provider: parameter
            inputs:
              key: outputDir
          - provider: static
            inputs:
              value: "./kubernetes/argocd/applications"

    rawTargets:
      description: Raw exec output listing cluster|folder pairs for overlays
      type: any
      resolve:
        with:
          - provider: exec
            inputs:
              command: "bash"
              args:
                - -c
                - |
                  for c in $(awk '/^clusters:/{start=1; next} start && /^[^ ]/{start=0} start && /^  [^ ]/{name=$0; gsub(/^  /,"",name); gsub(/:/,"",name); print name}' .scafctl/config.yaml); do
                    server=$(awk '/^  '"$c"':/{found=1; next} found && /^    server:/{sub(/^    server: */,""); print; found=0}' .scafctl/config.yaml)
                    for d in kubernetes/*/; do
                      app=$(basename "$d")
                      if [ -d "kubernetes/$app/overlays/$c" ] && [ "$app" != "argocd" ]; then
                        vault="false"
                        if awk '/^  '"$app"':/{found=1; next} found && /vault-plugin: true/{print "yes"; found=0} found && /^  [^ ]/{found=0}' .scafctl/config.yaml | grep -q yes; then
                          vault="true"
                        fi
                        echo "$c|$app|$server|$vault"
                      fi
                    done
                  done

    targets:
      description: List of cluster+folder targets to generate
      type: array
      resolve:
        with:
          - provider: cel
            inputs:
              expression: |
                _.rawTargets.stdout.split('\n').filter(line, line.size() > 0).map(line, {
                  'cluster': line.split('|')[0],
                  'folder': line.split('|')[1],
                  'server': line.split('|')[2],
                  'vault': line.split('|')[3] == 'true'
                })

  workflow:
    actions:
      createOutputDir:
        description: Ensure output directory exists
        provider: exec
        inputs:
          command: "mkdir"
          args:
            - "-p"
            - expr: "_.outputDir"

      generateApplications:
        description: Generate ArgoCD Application manifests for each target (cluster+folder)
        dependsOn: [createOutputDir]
        forEach:
          item: target
          in:
            rslvr: targets
        provider: file
        inputs:
          operation: write
          path:
            expr: "_.outputDir + '/' + target.cluster + '/' + target.folder + '.yaml'"
          createDirs: true
          content:
            tmpl: |
              ---
              apiVersion: argoproj.io/v1alpha1
              kind: Application
              metadata:
                name: {{ if eq .target.cluster "okd" }}{{ .target.folder }}{{ else }}{{ .target.folder }}-{{ .target.cluster }}{{ end }}
                namespace: argocd
                annotations:
                  argocd.argoproj.io/sync-wave: "1"
                  argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
                  notifications.argoproj.io/subscribe.on-sync-succeeded.gh-cluster: ""
                  notifications.argoproj.io/subscribe.on-sync-failed.gh-cluster: ""
                  notifications.argoproj.io/subscribe.on-sync-status-unknown.gh-cluster: ""
                  notifications.argoproj.io/subscribe.on-health-degraded.gh-cluster: ""
                labels:
                  app.kubernetes.io/instance: argocd
              spec:
                destination:
                  server: {{ .target.server }}
                project: default
                source:
                  path: kubernetes/{{ .target.folder }}/overlays/{{ .target.cluster }}
                  repoURL: {{ ._.repoURL }}
                  targetRevision: HEAD
                  {{- if .target.vault }}
                  plugin:
                    name: argocd-vault-plugin-kustomize
                  {{- end }}
                syncPolicy:
                  syncOptions:
                    - ServerSideApply=true
