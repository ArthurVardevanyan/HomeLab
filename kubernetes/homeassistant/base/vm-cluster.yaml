---
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMCluster
metadata:
  name: homeassistant
  namespace: homeassistant
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
spec:
  # renovate: datasource=github-releases depName=VictoriaMetrics/VictoriaMetrics
  clusterVersion: "v1.132.0-cluster"
  retentionPeriod: 100y
  vminsert:
    image:
      repository: docker.io/victoriametrics/vminsert
    replicaCount: 2
    resources:
      requests:
        cpu: "10m"
        memory: "32Mi"
      limits:
        cpu: "25m"
        memory: "256Mi"
    securityContext:
      runAsNonRoot: true
      readOnlyRootFilesystem: true
      allowPrivilegeEscalation: false
      seccompProfile:
        type: RuntimeDefault
      capabilities:
        drop:
          - ALL
    podDisruptionBudget:
      minAvailable: 1
      selectorLabels:
        app.kubernetes.io/name: vminsert
        app.kubernetes.io/instance: homeassistant
    topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: "topology.kubernetes.io/zone"
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: vminsert
            app.kubernetes.io/instance: homeassistant
      - maxSkew: 1
        topologyKey: "kubernetes.io/hostname"
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: vminsert
            app.kubernetes.io/instance: homeassistant
  vmselect:
    image:
      repository: docker.io/victoriametrics/vmselect
    replicaCount: 2
    cacheMountPath: "/select-cache"
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: rook-ceph-block
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 10Gi
    resources:
      requests:
        cpu: "10m"
        memory: "32Mi"
      limits:
        cpu: "100m"
        memory: "3Gi"
    securityContext:
      runAsNonRoot: true
      readOnlyRootFilesystem: true
      allowPrivilegeEscalation: false
      seccompProfile:
        type: RuntimeDefault
      capabilities:
        drop:
          - ALL
    podDisruptionBudget:
      minAvailable: 1
      selectorLabels:
        app.kubernetes.io/name: vmselect
        app.kubernetes.io/instance: homeassistant
    topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: "topology.kubernetes.io/zone"
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: vmselect
            app.kubernetes.io/instance: homeassistant
      - maxSkew: 1
        topologyKey: "kubernetes.io/hostname"
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: vmselect
            app.kubernetes.io/instance: homeassistant
  vmstorage:
    image:
      repository: docker.io/victoriametrics/vmstorage
    replicaCount: 2
    storageDataPath: "/vm-data"
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: rook-ceph-block
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 25Gi
    resources:
      requests:
        cpu: "10m"
        memory: "128Mi"
      limits:
        cpu: "50m"
        memory: "1Gi"
    securityContext:
      runAsNonRoot: true
      readOnlyRootFilesystem: true
      allowPrivilegeEscalation: false
      seccompProfile:
        type: RuntimeDefault
      capabilities:
        drop:
          - ALL
    podDisruptionBudget:
      minAvailable: 1
      selectorLabels:
        app.kubernetes.io/name: vmstorage
        app.kubernetes.io/instance: homeassistant
    topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: "topology.kubernetes.io/zone"
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: vmstorage
            app.kubernetes.io/instance: homeassistant
      - maxSkew: 1
        topologyKey: "kubernetes.io/hostname"
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: vmstorage
            app.kubernetes.io/instance: homeassistant
