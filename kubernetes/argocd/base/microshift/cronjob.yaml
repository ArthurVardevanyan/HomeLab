---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: microshift-credential-rotation
  annotations:
    checkov.io/skip1: CKV_K8S_40=OpenShift Injects Random UID
    checkov.io/skip2: CKV_K8S_43=Don't Mind Tag for This
    checkov.io/skip3: CKV_K8S_38= Require Use of Service Account Tokens
  namespace: argocd
spec:
  schedule: "0 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          tolerations:
            - key: node-role.kubernetes.io/control-plane
              effect: NoSchedule
            - key: node-role.kubernetes.io/control-plane
              effect: NoSchedule
          affinity:
            nodeAffinity:
              requiredDuringSchedulingIgnoredDuringExecution:
                nodeSelectorTerms:
                  - matchExpressions:
                      - key: node-role.kubernetes.io/control-plane
                        operator: Exists
                      - key: node-role.kubernetes.io/control-plane
                        operator: Exists
          securityContext:
            runAsNonRoot: true
            seccompProfile:
              type: RuntimeDefault
          serviceAccountName: argocd-creds
          containers:
            - name: microshift-credential-rotation
              image: registry.arthurvardevanyan.com/homelab/toolbox:not_latest
              securityContext:
                runAsNonRoot: true
                privileged: false
                readOnlyRootFilesystem: true
                allowPrivilegeEscalation: false
                seccompProfile:
                  type: RuntimeDefault
                capabilities:
                  drop:
                    - ALL
              resources:
                limits:
                  cpu: 50m
                  ephemeral-storage: 32Mi
                  memory: 128Mi
                requests:
                  cpu: 5m
                  ephemeral-storage: 16Mi
                  memory: 32Mi
              command:
                - "bash"
                - "-c"
                - |
                  set -o errexit
                  set -o nounset
                  set -o pipefail

                  SA_TOKEN_PATH="/var/run/secrets/openshift/serviceaccount/token"
                  if [[ ! -f "${SA_TOKEN_PATH}" ]]; then
                    echo "ERROR: Service account token not found at ${SA_TOKEN_PATH}" >&2
                    exit 1
                  fi

                  JSON='{
                    "namespace": "argocd",
                    "serviceAccountName": "argocd"
                  }'

                  echo "Exchanging service account token with KFCA..."
                  RESPONSE=$(curl --silent --show-error --fail --max-time 30 --retry 3 --retry-delay 5 \
                    --header "Authorization: Bearer $(cat "${SA_TOKEN_PATH}")" \
                    "https://kfca.microshift.arthurvardevanyan.com/exchangeToken" -X POST \
                    -H "Content-type: application/json" \
                    -H "Accept: application/json" \
                    -d "${JSON}") || {
                      echo "ERROR: KFCA token exchange request failed" >&2
                      exit 1
                    }

                  TOKEN=$(echo "${RESPONSE}" | jq --raw-output --exit-status '.status.token') || {
                    echo "ERROR: Failed to parse token from KFCA response" >&2
                    echo "Response: ${RESPONSE}" >&2
                    exit 1
                  }
                  if [[ -z "${TOKEN}" || "${TOKEN}" == "null" ]]; then
                    echo "ERROR: KFCA returned empty or null token" >&2
                    exit 1
                  fi

                  echo "Retrieving CA data from microshift secret..."
                  CA_DATA=$(kubectl get secret -n argocd microshift -o jsonpath='{.data.caData}' | base64 -d) || {
                    echo "ERROR: Failed to retrieve caData from secret argocd/microshift" >&2
                    exit 1
                  }
                  if [[ -z "${CA_DATA}" ]]; then
                    echo "ERROR: caData is empty in secret argocd/microshift" >&2
                    exit 1
                  fi

                  CONFIG_JSON=$(jq -n \
                    --arg token "${TOKEN}" \
                    --arg ca "${CA_DATA}" \
                    '{"bearerToken": $token, "tlsClientConfig": {"insecure": false, "caData": $ca}}')

                  CONFIG_BASE64=$(echo -n "${CONFIG_JSON}" | base64 | tr -d '\n')

                  echo "Patching microshift secret with rotated credentials..."
                  kubectl patch secret microshift -n argocd \
                    --type='merge' \
                    -p="{\"data\": {\"config\": \"${CONFIG_BASE64}\"}}"
                  echo "Credential rotation complete."

              volumeMounts:
                - name: serviceaccount-token
                  readOnly: true
                  mountPath: /var/run/secrets/openshift/serviceaccount
                - name: tmp
                  mountPath: /tmp
          volumes:
            - name: serviceaccount-token
              projected:
                sources:
                  - serviceAccountToken:
                      audience: openshift
                      expirationSeconds: 3600
                      path: token
                defaultMode: 420
            - name: tmp
              emptyDir:
                sizeLimit: 32Mi
