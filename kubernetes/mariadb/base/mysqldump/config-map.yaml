apiVersion: v1
kind: ConfigMap
metadata:
  name: mysqldump-config
  namespace: mariadb
  labels:
    name: mysqldump-config
    app.kubernetes.io/instance: mariadb
data:
  mysqldump.sh: |-
    #!/bin/sh

    echo "Rotating SQL Files"
    logrotate -vf  /tmp/mysqldump -s /tmp/state/logrotate.status

    URL=mariadb.mariadb
    LOCATION=/mnt/mysqldump

    echo "Dumping MariaDB mariadb Configs"
    mysqldump -h ${URL} --port=3306 -ubackup -pbackup  mysql           > ${LOCATION}/mysql/mysql.sql
    echo "Dumping Grafana"
    mysqldump -h ${URL} --port=3306 -ubackup -pbackup  grafana         > ${LOCATION}/grafana/grafana.sql
    echo "Dumping Nextcloud"
    mysqldump -h ${URL} --port=3306 -ubackup -pbackup  nextcloud       > ${LOCATION}/nextcloud/nextcloud.sql
    echo "Dumping Gitea"
    mysqldump -h ${URL} --port=3306 -ubackup -pbackup  gitea           > ${LOCATION}/gitea/gitea.sql
    echo "Dumping Spotify"
    mysqldump -h ${URL} --port=3306 -ubackup -pbackup  spotify         > ${LOCATION}/spotify/spotify.sql
    echo "Dumping Finance Tracker"
    mysqldump -h ${URL} --port=3306 -ubackup -pbackup  FinanceTracker  > ${LOCATION}/FinanceTracker/FinanceTracker.sql
    echo "Dumping Fitness Data"
    mysqldump -h ${URL} --port=3306 -ubackup -pbackup  fitness         > ${LOCATION}/fitness/fitness.sql

  mysqldump: |-
    /mnt/mysqldump/*/*.sql {
      daily
      rotate 75
      compress
      delaycompress
      create 640 65534 65534
      dateext
      dateformat .%Y-%m-%dT%H:%M:%S
    }
