apiVersion: v1
kind: ConfigMap
metadata:
  name: gitlab-runner
  labels:
    name: gitlab-runner
  namespace: gitlab-runner
data:
  config.toml: |-
    concurrent = 3
    check_interval = 5

    [session_server]
      session_timeout = 1800

    [[runners]]
    name = "gitlab-runner"
    url = "https://gitlab.<path:secret/data/gitlab/domain#url>/"
    token = "<path:secret/data/gitlab/runner#token>"
    executor = "kubernetes"
    [runners.kubernetes]
       namespace = "gitlab-runner"
       bearer_token_overwrite_allowed = true
       cpu_request= "100m"
       cpu_limit = "1"
       memory_request = "250M"
       memory_limit = "750M"
       service_cpu_request = "100m"
       service_cpu_limit = "750m"
       service_memory_request = "250M"
       service_memory_limit = "500M"
       helper_cpu_request = "50m"
       helper_cpu_limit = "150m"
       helper_memory_request = "50M"
       helper_memory_limit = "150M"
       poll_interval = 5
       poll_timeout = 3600
       dns_policy = "cluster-first"
       privileged = true
    [runners.kubernetes.pod_labels ]
      app = "runner"

  entrypoint: |
    #!/bin/bash
    set -e
    mkdir -p /home/gitlab-runner/.gitlab-runner/
    cp /scripts/config.toml /home/gitlab-runner/.gitlab-runner/

    # Start the runner
    exec /entrypoint run --user=gitlab-runner \
      --working-directory=/home/gitlab-runner

  check-live: |
    #!/bin/bash
    if /usr/bin/pgrep -f .*register-the-runner; then
      exit 0
    elif /usr/bin/pgrep gitlab.*runner; then
      exit 0
    else
      exit 1
    fi
