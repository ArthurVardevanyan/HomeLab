# rm docker-compose.yaml && nano docker-compose.yaml
# docker-compose down
# docker-compose pull
# docker-compose --compatibility up --detach  --remove-orphans
version: "3.7"

# More info at https://github.com/pi-hole/docker-pi-hole/ and https://docs.pi-hole.net/
services:
  registry:
    container_name: registry
    restart: always
    image: registry:2
    environment:
      - REGISTRY_STORAGE_DELETE_ENABLED=true
    ports:
      - "5000:5000"
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    hostname: pihole
    networks:
      dockerBridge:
        ipv4_address: 10.0.0.4
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "67:67/udp"
      - "80:80/tcp"
    deploy:
      resources:
        limits:
          cpus: "0.5"
    environment:
      TZ: "America/Chicago"
    volumes:
      - "./docker/pihole/etc-pihole/:/etc/pihole/"
      - "./docker/pihole/etc-dnsmasq.d/:/etc/dnsmasq.d/"
    # Recommended but not required (DHCP needs NET_ADMIN)
    #   https://github.com/pi-hole/docker-pi-hole#note-on-capabilities
    cap_add:
      - NET_ADMIN
    restart: unless-stopped
  gitlab:
    container_name: gitlab
    hostname: gitlab
    image: "gitlab/gitlab-ce:latest"
    restart: always
    networks:
      dockerBridge:
        ipv4_address: 10.0.0.9
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://10.0.0.9/'
        # Add any other gitlab.rb configuration here, each on its own line
    ports:
      - "80:80"
      - "443:443"
      - "22:22"
      - "5000:5000"
      - "5050:5050"
      - "8093:8093"
    deploy:
      resources:
        limits:
          cpus: "0.75"
    volumes:
      - "./docker/gitlab/config:/etc/gitlab"
      - "./docker/gitlab/logs:/var/log/gitlab"
      - "./docker/gitlab/data:/var/opt/gitlab"
  gitlab-runner:
    container_name: gitlab-runner
    image: gitlab/gitlab-runner
    restart: unless-stopped
    depends_on:
      - gitlab
    volumes:
      - "./docker/gitlab-runner:/etc/gitlab-runner"
      - "./docker/gitlab-docker:/etc/docker"
      - /var/run/docker.sock:/var/run/docker.sock
    network_mode: "service:gitlab"
    deploy:
      resources:
        limits:
          cpus: "0.5"
  mariadb:
    container_name: mariadb
    image: mariadb
    restart: always
    networks:
      dockerBridge:
        ipv4_address: 10.0.0.5
    ports:
      - "80:80"
      - "3306:3306"
    volumes:
      - "./docker/mariadb/data:/var/lib/mysql"
      - "./docker/mariadb/mysql:/etc/mysql"
  nextcloud:
    container_name: nextcloud
    hostname: nextcloud
    image: nextcloud
    restart: always
    ports:
      - 7070:7070
    volumes:
      - "./docker/nextcloud/nextcloud:/var/www/html"
      - "./docker/nextcloud/apps:/var/www/html/custom_apps"
      - "./docker/nextcloud/config:/var/www/html/config"
      - "/backup/File_Storage/Nextcloud:/var/www/html/data"
      - "./docker/nextcloud/apache2:/etc/apache2"
      - "./docker/nextcloud/letsencrypt/:/etc/letsencrypt"
    depends_on:
      - mariadb
  phpmyadmin:
    container_name: phpmyadmin
    image: phpmyadmin
    restart: always
    network_mode: "service:mariadb"
    depends_on:
      - mariadb
    environment:
      - PMA_HOST=10.0.0.5
  analytics-for-spotify:
    container_name: analytics-for-spotify
    hostname: analytics-for-spotify
    image: "10.0.0.9:5050/arthurvardevanyan/analytics-for-spotify:latest"
    restart: always
    networks:
      dockerBridge:
        ipv4_address: 10.0.0.6
    ports:
      - "80:80"
    deploy:
      resources:
        limits:
          cpus: "0.5"
    depends_on:
      - mariadb
networks:
  dockerBridge:
    external: true
