# sudo rm docker-compose.yaml && sudo nano docker-compose.yaml
# sudo rm docker-compose.yaml && nano docker-compose.yaml
# docker system prune -a
# docker image prune -a
# docker system prune --volumes
# docker kill $(docker ps -q)
# docker-compose down
# docker-compose pull
# docker-compose --compatibility up --detach  --remove-orphans
version: "3.7"

services:
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    hostname: pihole
    networks:
      dockerBridge:
        ipv4_address: 10.0.0.4
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "67:67/udp"
      - "80:80/tcp"
    deploy:
      resources:
        limits:
          cpus: "0.5"
    environment:
      TZ: "America/Chicago"
    volumes:
      - "/home/arthur/docker/pihole/etc-pihole/:/etc/pihole/"
      - "/home/arthur/docker/pihole/etc-dnsmasq.d/:/etc/dnsmasq.d/"
    cap_add:
      - NET_ADMIN
    restart: unless-stopped
  gitlab:
    container_name: gitlab
    hostname: gitlab
    image: "gitlab/gitlab-ce:latest"
    restart: always
    networks:
      dockerBridge:
        ipv4_address: 10.0.0.9
    ports:
      - "80:80"
      - "443:443"
      - "22:22"
      - "5000:5000"
      - "5050:5050"
      - "8093:8093"
    deploy:
      resources:
        limits:
          cpus: "0.75"
    volumes:
      - "/home/arthur/docker/gitlab/config:/etc/gitlab"
      - "/home/arthur/docker/gitlab/logs:/var/log/gitlab"
      - "/home/arthur/docker/gitlab/data:/var/opt/gitlab"
  gitlab-runner:
    container_name: gitlab-runner
    image: gitlab/gitlab-runner
    restart: unless-stopped
    depends_on:
      - gitlab
    volumes:
      - "/home/arthur/docker/gitlab-runner:/etc/gitlab-runner"
      - "/home/arthur/docker/gitlab-docker:/etc/docker"
      - "/home/arthur/docker/gitlab-hosts/hosts:/etc/hosts"
      - /var/run/docker.sock:/var/run/docker.sock
    network_mode: "service:gitlab"
    deploy:
      resources:
        limits:
          cpus: "0.75"
  mariadb:
    container_name: mariadb
    image: mariadb
    restart: always
    networks:
      dockerBridge:
        ipv4_address: 10.0.0.5
    ports:
      - "80:80"
      - "3306:3306"
    volumes:
      - "/home/arthur/docker/mariadb/data:/var/lib/mysql"
      - "/home/arthur/docker/mariadb/mysql:/etc/mysql"
  nextcloud:
    container_name: nextcloud
    hostname: nextcloud
    image: nextcloud
    restart: always
    ports:
      - 7070:7070
    volumes:
      - "/home/arthur/docker/nextcloud/nextcloud:/var/www/html"
      - "/home/arthur/docker/nextcloud/apps:/var/www/html/custom_apps"
      - "/home/arthur/docker/nextcloud/config:/var/www/html/config"
      - "/backup/File_Storage/Nextcloud:/var/www/html/data"
      - "/home/arthur/docker/nextcloud/apache2:/etc/apache2"
      - "/home/arthur/docker/nextcloud/letsencrypt/:/etc/letsencrypt"
    depends_on:
      - mariadb
    deploy:
      resources:
        limits:
          cpus: "0.75"
  phpmyadmin:
    container_name: phpmyadmin
    image: phpmyadmin
    restart: always
    network_mode: "service:mariadb"
    depends_on:
      - mariadb
    environment:
      - PMA_HOST=10.0.0.5
      - UPLOAD_LIMIT=500M
    deploy:
      resources:
        limits:
          cpus: "0.5"
  homeassistant:
    container_name: homeassistant
    hostname: homeassistant
    image: homeassistant/home-assistant
    restart: unless-stopped
    ports:
      - 8123:8123
    networks:
        dockerBridge:
          ipv4_address: 10.0.0.3
    volumes:
      - "/etc/localtime:/etc/localtime:ro"
      - "/home/arthur/docker/homeassistant/:/config"    
    deploy:
      resources:
        limits:
          cpus: "0.75"
  analytics-for-spotify:
    container_name: analytics-for-spotify
    hostname: analytics-for-spotify
    env_file: .env
    image: ${REPOSITORY}
    environment:
      - DOCKER=YES
      - CLIENT_ID=${CLIENT_ID}
      - CLIENT_SECRET=${CLIENT_SECRET}
      - REDIRECT_URL=${REDIRECT_URL}
      - HOST=${HOST}
      - DATABASE=${DATABASE}
      - USER=${USERNAME}
      - PASSWORD=${PASSWORD}
    restart: always
    networks:
      dockerBridge:
        ipv4_address: 10.0.0.6
    ports:
      - "80:80"
    deploy:
      resources:
        limits:
          cpus: "0.75"
    depends_on:
      - mariadb
networks:
  dockerBridge:
    external: true
