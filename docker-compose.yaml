# export GITLAB_HOME=/srv/gitlab
# rm docker-compose.yaml && nano docker-compose.yaml
# docker-compose --compatibility up --detach
version: "3.7"

# More info at https://github.com/pi-hole/docker-pi-hole/ and https://docs.pi-hole.net/
services:
  registry:
    container_name: registry
    restart: always
    image: registry:2
    environment:
      - REGISTRY_STORAGE_DELETE_ENABLED=true
    ports:
      - "5000:5000"
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    hostname: pihole
    networks:
      dockerBridge:
        ipv4_address: 10.0.0.4
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "67:67/udp"
      - "80:80/tcp"
    deploy:
      resources:
        limits:
          cpus: "0.5"
    environment:
      TZ: "America/Chicago"
      # WEBPASSWORD: 'set a secure password here or it will be random'
    # Volumes store your data between container upgrades
    volumes:
      - "./etc-pihole/:/etc/pihole/"
      - "./etc-dnsmasq.d/:/etc/dnsmasq.d/"
    # Recommended but not required (DHCP needs NET_ADMIN)
    #   https://github.com/pi-hole/docker-pi-hole#note-on-capabilities
    cap_add:
      - NET_ADMIN
    restart: unless-stopped
  
  #registry-ui: # https://medium.com/@rukeith/note-learn-how-to-build-private-docker-registry-with-website-and-use-it-81d6916b7adc
  #  image: konradkleine/docker-registry-frontend:v2
  #  container_name: registry-ui
  #  labels:
  #    - "PROJECT=registry"
  #  ports:
  #    - 5001:80
  #  environment:
  #    - ENV_DOCKER_REGISTRY_PORT=5000
  #    - ENV_DOCKER_REGISTRY_HOST=registry
  #  depends_on:
  #    - registry
      
  gitlab:
    # export GITLAB_HOME=/srv/gitlab
    container_name: gitlab
    image: "gitlab/gitlab-ce:latest"
    restart: always
    networks:
      dockerBridge:
        ipv4_address: 10.0.0.9
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://10.0.0.9/'
        # Add any other gitlab.rb configuration here, each on its own line
    ports:
      - "80:80"
      - "443:443"
      - "22:22"
    deploy:
      resources:
        limits:
          cpus: "0.5"
    volumes:
      - "$GITLAB_HOME/config:/etc/gitlab"
      - "$GITLAB_HOME/logs:/var/log/gitlab"
      - "$GITLAB_HOME/data:/var/opt/gitlab"

  analytics-for-spotify:
    container_name: analytics-for-spotify
    image: "localhost:5000/analytics-for-spotify:202106140827"
    restart: always
    networks:
      dockerBridge:
        ipv4_address: 10.0.0.6
    
    ports:
      - "80:80"
    deploy:
      resources:
        limits:
          cpus: "0.5"

networks:
  dockerBridge:
    external: true
