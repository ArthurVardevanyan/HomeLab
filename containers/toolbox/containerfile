# Clair base extractor
FROM quay.io/projectquay/clair-action:v0.0.12@sha256:adfc28d51f08b82978aa6dc41b166b05a2a728fa9643c3a1b73b2032f18e7c30 AS clair


# Node tool build stage (Node is NOT in final image)
FROM node:25.1.0-trixie@sha256:61d7b34e007da0a6403408afc0a79f7313b414a45ee221d273b39ff5a6f59bb4 AS node-tools
ENV MARKDOWNLINT_CLI_VERSION=0.45.0
ENV PRETTIER_CLI_VERSION=3.6.2
RUN npm install -g \
  markdownlint-cli@${MARKDOWNLINT_CLI_VERSION} \
  prettier@${PRETTIER_CLI_VERSION}


# Final base image
FROM quay.io/centos/centos:stream10-minimal@sha256:308328cfe82a473da8d5d8ca0c18d50be898f337ea433d57b7d4f2fcf0cbfccb

# ---- ALL VERSION VARIABLES HERE — SINGLE SOURCE OF TRUTH ----
ENV \
  ARGOCD_VAULT_VERSION=1.18.1 \
  OKD_VERSION=4.20.0-okd-scos.7 \
  OPENTOFU_VERSION=1.10.6 \
  VAULT_VERSION=1.20.3 \
  KO_VERSION=0.18.0 \
  GH_VERSION=2.79.0 \
  KUBECONFORM_VERSION=0.7.0 \
  ANSIBLE_VERSION=12.2.0 \
  GCLOUD_VERSION=546.0.0 \
  GO_VERSION=1.25.1 \
  MARKDOWNLINT_CLI_VERSION=0.45.0 \
  PRETTIER_CLI_VERSION=3.6.2

# System paths
ENV \
  LANG=en_US.UTF-8 \
  LC_ALL=en_US.UTF-8 \
  HOME=/tmp \
  GOROOT=/usr/local/go \
  GOPATH=/go \
  GO111MODULE=on \
  CGO_ENABLED=0 \
  PATH=/usr/local/go/bin:/go/bin:/usr/local/bin:/usr/bin:/bin


# Pull clair binary
COPY --from=clair /bin/clair-action /usr/local/bin/clair-action


# Base packages — optimized install
RUN rpm --import https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-10 && \
  rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-10.noarch.rpm && \
  rpm -Uvh https://download.postgresql.org/pub/repos/yum/reporpms/EL-10-x86_64/pgdg-redhat-repo-latest.noarch.rpm && \
  microdnf -y update && \
  microdnf -y install --nodocs --setopt=install_weak_deps=0 \
  libpmem tcpdump sshpass rsync rclone git jq unzip tar make ShellCheck \
  fio mariadb postgresql17 python3 python3-pip procps && \
  ln -sf /usr/bin/python3 /usr/local/bin/python && \
  microdnf clean all && rm -rf /var/cache/*


# Python tooling
RUN pip3 install --no-cache-dir ansible==${ANSIBLE_VERSION}


# Copy node CLIs into final image (runtime NOT included)
COPY --from=node-tools /usr/local/bin/* /usr/local/bin/
COPY --from=node-tools /usr/local/lib/node_modules /usr/local/lib/node_modules


# GitHub CLI (version referenced from ENV)
RUN curl -sSL https://github.com/cli/cli/releases/download/v${GH_VERSION}/gh_${GH_VERSION}_linux_amd64.tar.gz \
  | tar -xz --strip-components=2 -C /usr/local/bin "gh_${GH_VERSION}_linux_amd64/bin/gh"


# Core CLI binaries — all versioned
RUN set -eux; \
  curl -L -o /usr/local/bin/argocd-vault-plugin \
  "https://github.com/argoproj-labs/argocd-vault-plugin/releases/download/v${ARGOCD_VAULT_VERSION}/argocd-vault-plugin_${ARGOCD_VAULT_VERSION}_linux_amd64" && \
  chmod +x /usr/local/bin/argocd-vault-plugin && \
  curl -L -o /usr/local/bin/yq \
  "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64" && chmod +x /usr/local/bin/yq && \
  curl -L https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz \
  | tar -xz -C /usr/local/bin kubeconform && chmod +x /usr/local/bin/kubeconform && \
  curl -L -o /usr/local/bin/mc \
  "https://dl.min.io/client/mc/release/linux-amd64/mc" && chmod +x /usr/local/bin/mc && \
  curl -L "https://github.com/GoogleCloudPlatform/gcloud-slim/releases/download/${GCLOUD_VERSION}/gcloud-slim-linux-amd64" \
  -o /usr/local/bin/gcloud && chmod +x /usr/local/bin/gcloud


# Install Go by version variable
RUN curl -L -o go.tar.gz "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" && \
  tar -xzf go.tar.gz -C /usr/local --no-same-owner && rm -f go.tar.gz


# Precompile stdlib for faster x86 + arm64 builds
RUN mkdir -p /go && \
  GOOS=linux GOARCH=amd64 GOAMD64=v3 go build -std -v std && \
  GOOS=linux GOARCH=arm64 go build -std -v std


# Remove unnecessary runtime debris
RUN rm -rf /usr/local/go/test /usr/local/go/doc /usr/local/go/api /usr/local/go/misc


# Final slim-down
RUN strip /usr/local/bin/* || true && \
  rm -rf /usr/share/doc/* /usr/share/man/* /usr/share/info/* /tmp/*


CMD ["sleep", "infinity"]
