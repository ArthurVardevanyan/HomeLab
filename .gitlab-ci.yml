stages:
  - images
  - test
  - ansible
  - kubernetes
  - github

GithubPending:
  stage: test
  image: $CI_REGISTRY_IMAGE:toolbox
  script:
    - export DESCRIPTION="Running"
    - export STATUS=pending
    - ./.github-status.sh

GithubFinish:
  stage: github
  image: $CI_REGISTRY_IMAGE:toolbox
  script:
    - export DESCRIPTION="Completed Successfully"
    - export STATUS=success
    - ./.github-status.sh

AnsibleDesktopCheck:
  stage: ansible
  image: $CI_REGISTRY_IMAGE:ansible
  allow_failure: true
  before_script:
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ansible-playbook -i ansible/inventory ansible/desktop.yaml --extra-vars "ansible_become_pass=${SUDO} ansible_ssh_pass=${SUDO} ansible_python_interpreter=/usr/bin/python3" --check

AnsibleDesktop:
  stage: ansible
  image: $CI_REGISTRY_IMAGE:ansible
  needs: [AnsibleDesktopCheck]
  allow_failure: true
  before_script:
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - ansible-playbook -i ansible/inventory ansible/desktop.yaml --extra-vars "ansible_become_pass=${SUDO} ansible_ssh_pass=${SUDO} ansible_python_interpreter=/usr/bin/python3" --check

include:
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml
  - local: ".gitlab-ci-images.yml"
  - local: ".gitlab-ci-ansible.yml"
  - local: ".gitlab-ci-kubernetes.yml"

variables:
  SCAN_KUBERNETES_MANIFESTS: "true"
