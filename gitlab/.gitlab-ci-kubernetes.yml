metricsServer:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - kubectl patch deployment -n kube-system metrics-server --patch "$(cat kubernetes/metrics-server/metrics-server-deployment.yaml)"

kubernetes-dashboard:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - sed -i "s/<URL>/${URL}/g" kubernetes/kubernetes-dashboard/kubernetes-dashboard-traefik.yaml
    - kubectl apply -f kubernetes/kubernetes-dashboard

certManager:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - sh kubernetes/cert-manager/cert-manager-deployment.sh
    - sed -i "s/<URL>/${URL}/g" kubernetes/cert-manager/cert-manager-cloudflare.yaml
    - sed -i "s,<CLOUDFLARE_EMAIL>,${CLOUDFLARE_EMAIL},g" kubernetes/cert-manager/cert-manager-cloudflare.yaml
    - sed -i "s,<CLOUDFLARE_API>,${CLOUDFLARE_API},g" kubernetes/cert-manager/cert-manager-cloudflare-secret.yaml
    - kubectl apply -f kubernetes/cert-manager

versionChecker:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - kubectl apply -f kubernetes/version-checker

traefik:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - sed -i "s/<URL>/${URL}/g" kubernetes/traefik/traefik-dashboard-traefik.yaml
    - sed -i "s/<URL>/${URL}/g" kubernetes/traefik/cluster-wildcard-certificate.yaml
    - kubectl apply -f kubernetes/traefik

heimdall:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - sed -i "s/<URL>/${URL}/g" kubernetes/heimdall/heimdall-traefik.yaml
    - kubectl apply -f kubernetes/heimdall

gitlab:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - sed -i "s/<URL>/${URL}/g" kubernetes/gitlab/gitlab-traefik.yaml
    - kubectl apply -f kubernetes/gitlab

gitlab-runner:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - sed -i "s/<URL>/${URL}/g" kubernetes/gitlab/gitlab-runner/gitlab-runner-config-map.yaml
    - kubectl apply -f kubernetes/gitlab/gitlab-runner/

influxdb:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - kubectl apply -f kubernetes/influxdb

prometheus:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - sed -i "s/<URL>/${URL}/g" kubernetes/prometheus/prometheus-traefik.yaml
    - kubectl apply -f kubernetes/prometheus

kube-state-metrics:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - kubectl apply -f kubernetes/kube-state-metrics

grafana:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - sed -i "s/<URL>/${URL}/g" kubernetes/grafana/grafana-traefik.yaml
    - kubectl apply -f kubernetes/grafana

nextcloud:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - sed -i "s/<URL>/${URL}/g" kubernetes/nextcloud/nextcloud-traefik.yaml
    - kubectl apply -f kubernetes/nextcloud

mariadb:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - sed -i "s,<PASSWORD>,${SUDO},g" kubernetes/mariadb/mariadb-env-configmap.yaml
    - kubectl apply -f kubernetes/mariadb

phpmyadmin:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - sed -i "s/<URL>/${URL}/g" kubernetes/phpmyadmin/phpmyadmin-traefik.yaml
    - kubectl apply -f kubernetes/phpmyadmin

homeassistant:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - kubectl apply -f kubernetes/homeassistant

vault:
  stage: kubernetes
  when: always
  needs: []
  image: $CI_REGISTRY_IMAGE:kubernetes
  environment: production
  script:
    - sed -i "s/<URL>/${URL}/g" kubernetes/vault/vault-traefik.yaml
    - kubectl apply -f kubernetes/vault
