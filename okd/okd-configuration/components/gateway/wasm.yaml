# http://redhat.com/en/blog/creating-web-application-firewall-red-hat-openshift
apiVersion: extensions.istio.io/v1alpha1
kind: WasmPlugin
metadata:
  name: coraza-waf
  namespace: openshift-ingress
spec:
  imagePullPolicy: IfNotPresent
  phase: AUTHN
  pluginConfig:
    default_directives: default
    directives_map:
      default:
        - Include @demo-conf
        - SecDebugLogLevel 9
        - SecRuleEngine On
        - SecRule REQUEST_HEADERS:Host "@streq vault.arthurvardevanyan.com" "id:1000,phase:1,pass,nolog,chain"
        - SecRule REQUEST_URI "@beginsWith /v1/auth/" "ctl:ruleRemoveById=911100,ctl:ruleRemoveById=949111"
        - SecRule REQUEST_HEADERS:Host "@streq files.arthurvardevanyan.com" "id:1001,phase:1,pass,nolog,chain"
        - SecRule REQUEST_URI "@beginsWith /remote.php/dav/" "ctl:ruleRemoveById=911100,ctl:ruleRemoveById=949111"
        - Include @crs-setup-conf
        - Include @owasp_crs/*.conf
  selector:
    matchLabels:
      gateway.networking.k8s.io/gateway-name: https-gateway
  # renovate: datasource=docker depName=ghcr.io/corazawaf/coraza-proxy-wasm
  url: oci://ghcr.io/corazawaf/coraza-proxy-wasm:0.6.0@sha256:65d6009b9da2e8965e592a08b74a86725435fc01aa39c756dce0bd5ea64b3f4e
